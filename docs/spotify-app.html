<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <script src="spotify-web-api.js"></script>

    <style type="text/css">
        #login, #loggedin {
          display: none;
        }
        .text-overflow {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          width: 500px;
        }
    </style>
    <title>Purecloud Spotify App</title>
</head>
<body>
    <div class="container">
        <!-- Landing page / Login -->
        <div id="login">
            <h1>Login in to Spotify</h1>
            <button id="login-button" class="btn btn-primary">Log in with Spotify</button>
        </div>

        <!-- If user is logged in to Spotify -->
        <div id="loggedin">
            <div id="current-track"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="creds.js"></script>
    <script>
    (function(){
        var spotifyApi = new SpotifyWebApi();
        var stateKey = 'spotify_auth_state';

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        /**
         * Generates a random string containing numbers and letters
         * @param  {number} length The length of the string
         * @return {string} The generated string
         */
        function generateRandomString(length) {
            var text = '';
            var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (var i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        };
        
        /**
         * Polling function that gets the current track of user
         */
        function getCurrentTrack(){
            spotifyApi.getMyCurrentPlayingTrack()
            .then(function(data){
                $('#current-track').html(data.item.name);
            }, function (err){
                console.error(err);
            });

            setTimeout(getCurrentTrack, 5000);
        }

        // Get URL parameters and authorization information
        var params = getHashParams();
        var access_token = params.access_token,
            state = params.state,
            storedState = localStorage.getItem(stateKey);

        if (access_token && (state == null || state !== storedState)) {
            alert('There was an error during the authentication');
        } else {
            localStorage.removeItem(stateKey);
            
            if (access_token) {
                $('#login').hide();
                $('#loggedin').show();

                spotifyApi.setAccessToken(access_token);
                getCurrentTrack();
            } else {
                $('#login').show();
                $('#loggedin').hide();
            }

            document.getElementById('login-button').addEventListener('click', function() {
                var state = generateRandomString(16);
                localStorage.setItem(stateKey, state);
                var scope = 'user-read-currently-playing';
                var url = 'https://accounts.spotify.com/authorize';
                url += '?response_type=token';
                url += '&client_id=' + encodeURIComponent(purecloudSpotifyCreds.spotify_clientId);
                url += '&scope=' + encodeURIComponent(scope);
                url += '&redirect_uri=' + encodeURIComponent(purecloudSpotifyCreds.app_page);
                url += '&state=' + encodeURIComponent(state);
                window.location = url;
            }, false);
        }    
    })();
    </script>
</body>
</html>